<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Login - FreeMart</title>
    <link rel="stylesheet" href="../public/assets/css/home.css" />
  </head>
  <body>
    <header>
      <h1>FreeMart</h1>
      <nav>
        <a href="home.html">Home</a>
        <a href="login.html">Login</a>
        <a href="signup.html">Sign Up</a>
      </nav>
    </header>
    <main class="container">
      <div class="auth-card">
        <form class="form">
          <h2>Welcome back</h2>
          <p class="muted-small">Sign in to access your FreeMart account</p>
          <div class="spacer-12"></div>
          <label for="phone">Phone number</label>
          <input
            class="input"
            type="text"
            id="phone"
            name="phone"
            placeholder="Enter your phone number"
            title="Phone number"
            required
          />

          <label for="password">Password</label>
          <input
            class="input"
            type="password"
            id="password"
            name="password"
            placeholder="Enter your password"
            title="Password"
            required
          />

          <button class="button btn primary full-width" type="submit">Login</button>
          <div class="form-help" aria-live="polite">
            <!-- Placeholder for error/help text -->
          </div>
          <div class="center" style="margin-top:10px">
            <a href="signup.html" class="btn link">Create account</a>
          </div>
        </form>
      </div>
    </main>

    <script>
      const API_BASE = "http://localhost:4000/api";
      function isValidPhone(p) {
        // Basic international/local phone check (digits, +, -, spaces)
        return /^\+?[0-9\-\s]{7,15}$/.test(p);
      }

      // If already logged in, go to profile selector
      if (localStorage.getItem('jwt_token')) {
        // small delay to allow the page to render
        setTimeout(() => { window.location.href = 'profile-selector.html'; }, 300);
      }

      document.querySelector('form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const phone = document.getElementById('phone').value.trim();
        const password = document.getElementById('password').value;
        const help = document.querySelector('.form-help');
        help.textContent = '';

        if (!phone || !isValidPhone(phone)) { help.textContent = 'Enter a valid phone number'; return; }
        if (!password || password.length < 8) { help.textContent = 'Password must be at least 8 characters'; return; }

        try {
          const res = await fetch(`${API_BASE}/auth/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ phone, password }),
          });
          const data = await res.json();
          if (!res.ok) {
            help.textContent = data.error || 'Login failed';
            return;
          }

          if (data.token) localStorage.setItem('jwt_token', data.token);
          if (data.user && data.user.current_profile_mode) {
            localStorage.setItem('current_profile_mode', data.user.current_profile_mode);
          } else {
            localStorage.setItem('current_profile_mode', localStorage.getItem('current_profile_mode') || 'consumer');
          }

          // Redirect to home page after successful login
          window.location.href = 'home.html';
        } catch (err) {
          console.error(err);
          help.textContent = 'Network error';
        }
      });
    </script>
  </body>
</html>
